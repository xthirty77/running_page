name: æ¯æ—¥è·‘æ­¥æ£€æŸ¥

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ™šä¸Š8ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 12 * * *'  # UTCæ—¶é—´12:00 = åŒ—äº¬æ—¶é—´20:00
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  check-running:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install requests

      - name: æ£€æŸ¥ä»Šæ—¥è·‘æ­¥è®°å½•
        env:
          # é‚®ä»¶é…ç½®
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          # Serveré…±é…ç½®
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python check_daily_running.py
        continue-on-error: true

      - name: å‘é€è·‘æ­¥æé†’ - Serveré…±
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sendkey = process.env.SERVERCHAN_SENDKEY;
            if (!sendkey) {
              console.log('Serveré…±SendKeyæœªé…ç½®ï¼Œè·³è¿‡å¾®ä¿¡é€šçŸ¥');
              return;
            }
            
            const title = "ğŸƒâ€â™‚ï¸ è·‘æ­¥æé†’ - ä»Šæ—¥è¿˜æœªè·‘æ­¥";
            const content = "ä»Šå¤©è¿˜æ²¡æœ‰è·‘æ­¥è®°å½•å“¦ï¼\n\næ˜¯æ—¶å€™å‡ºå»è·‘ä¸€è·‘äº†ï¼Œè®©èº«ä½“å’Œå¿ƒçµéƒ½å¾—åˆ°é”»ç‚¼ï¼\n\nè®°ä½ï¼šæ¯ä¸€æ¬¡è·‘æ­¥éƒ½æ˜¯å¯¹è‡ªå·±çš„æŠ•èµ„ï¼ğŸ’ª\n\nåŠ æ²¹ï¼ä½ å¯ä»¥çš„ï¼ğŸš€";
            
            const data = {
              title: title,
              desp: content
            };
            
            try {
              const response = await fetch(`https://sctapi.ftqq.com/${sendkey}.send`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
              });
              
              if (response.ok) {
                const result = await response.json();
                if (result.code === 0) {
                  console.log('Serveré…±å¾®ä¿¡é€šçŸ¥å‘é€æˆåŠŸ');
                } else {
                  console.log('Serveré…±å¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥:', result.message);
                }
              } else {
                console.log('Serveré…±å¾®ä¿¡é€šçŸ¥å‘é€å¤±è´¥: HTTP', response.status);
              }
            } catch (error) {
              console.log('Serveré…±å¾®ä¿¡é€šçŸ¥å‘é€å‡ºé”™:', error.message);
            }
        env:
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}

      - name: å‘é€è·‘æ­¥æé†’ - é‚®ä»¶
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SENDER_EMAIL }}
          password: ${{ secrets.SENDER_PASSWORD }}
          subject: "ğŸƒâ€â™‚ï¸ è·‘æ­¥æé†’ - ä»Šæ—¥è¿˜æœªè·‘æ­¥"
          to: ${{ secrets.RECIPIENT_EMAIL }}
          from: ${{ secrets.SENDER_EMAIL }}
          body: |
            <h2>ğŸƒâ€â™‚ï¸ è·‘æ­¥æé†’</h2>
            <p>ä»Šå¤©è¿˜æ²¡æœ‰è·‘æ­¥è®°å½•å“¦ï¼</p>
            <p>æ˜¯æ—¶å€™å‡ºå»è·‘ä¸€è·‘äº†ï¼Œè®©èº«ä½“å’Œå¿ƒçµéƒ½å¾—åˆ°é”»ç‚¼ï¼</p>
            <p>è®°ä½ï¼šæ¯ä¸€æ¬¡è·‘æ­¥éƒ½æ˜¯å¯¹è‡ªå·±çš„æŠ•èµ„ï¼ğŸ’ª</p>
            <p>åŠ æ²¹ï¼ä½ å¯ä»¥çš„ï¼ğŸš€</p>
          html: true
